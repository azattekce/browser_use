{% extends "base.html" %}

{% block title %}Test Sonucu #{{ test_result.id }} - {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('project.list_projects') }}">Projeler</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('project.project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                            <li class="breadcrumb-item active">Test #{{ test_result.id }}</li>
                        </ol>
                    </nav>
                    <h1 class="h2 mb-0">
                        <i class="fas fa-flask text-primary"></i>
                        Test Sonucu #{{ test_result.id }}
                    </h1>
                </div>
                <div class="d-flex gap-2">
                    {% if docker_running and not (request.host and 'azurecontainerapps.io' in request.host) %}
                    <button onclick="openVNC()" class="btn btn-success me-2" title="Browser görüntüsünü VNC ile izle">
                        <i class="fas fa-desktop me-2"></i> Browser Görüntüsü
                    </button>
                    {% elif docker_running %}
                    <button class="btn btn-info me-2" disabled title="Azure Container Apps'te VNC erişimi kısıtlıdır">
                        <i class="fas fa-info-circle me-2"></i> VNC: Azure'da Kısıtlı
                    </button>
                    {% endif %}
                    <a href="{{ url_for('project.project_detail', project_id=project.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Projeler
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-8 p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3">
                                    <div class="bg-light rounded-circle p-3" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-code text-primary fs-4"></i>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="mb-1">{{ project.name }}</h3>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-link me-1"></i>
                                        <a href="{{ test_result.project_url or project.url }}" target="_blank" class="text-decoration-none">
                                            {{ test_result.project_url or project.url }}
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 p-4 bg-light border-start">
                            <div class="text-center">
                                {% if test_result.status == 'running' %}
                                    <div class="mb-2">
                                        <span class="badge bg-warning fs-5 px-3 py-2">
                                            <i class="fas fa-spinner fa-spin me-2"></i> Test Çalışıyor
                                        </span>
                                    </div>
                                {% elif test_result.status == 'completed' %}
                                    <div class="mb-2">
                                        <span class="badge bg-success fs-5 px-3 py-2">
                                            <i class="fas fa-check-circle me-2"></i> Test Tamamlandı
                                        </span>
                                    </div>
                                {% elif test_result.status == 'failed' %}
                                    <div class="mb-2">
                                        <span class="badge bg-danger fs-5 px-3 py-2">
                                            <i class="fas fa-exclamation-circle me-2"></i> Test Başarısız
                                        </span>
                                    </div>
                                {% else %}
                                    <div class="mb-2">
                                        <span class="badge bg-secondary fs-5 px-3 py-2">
                                            <i class="fas fa-clock me-2"></i> {{ test_result.status|title }}
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column - Test Details -->
        <div class="col-lg-4 mb-4">
            <!-- Test Info Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-info-circle text-primary me-2"></i> Test Promptu</h5>
                </div>
                <div class="card-body">
                    <h6 class="fw-bold">{{ prompt.name }}</h6>
                    <div class="bg-light rounded p-3 mt-3">
                        <small class="text-muted d-block mb-2">Prompt İçeriği:</small>
                        <div class="font-monospace small" style="max-height: 200px; overflow-y: auto;">
                            {{ prompt.content[:300] }}{% if prompt.content|length > 300 %}...{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Info Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-clock text-info me-2"></i> Zaman Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-play text-success mb-2 fs-4"></i>
                                <div class="small text-muted">Başlama</div>
                                <div class="fw-bold">{{ test_result.created_at.strftime('%H:%M:%S') }}</div>
                                <div class="small">{{ test_result.created_at.strftime('%d.%m.%Y') }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                {% if test_result.completed_at %}
                                    <i class="fas fa-stop text-danger mb-2 fs-4"></i>
                                    <div class="small text-muted">Tamamlanma</div>
                                    <div class="fw-bold">{{ test_result.completed_at.strftime('%H:%M:%S') }}</div>
                                    <div class="small">{{ test_result.completed_at.strftime('%d.%m.%Y') }}</div>
                                {% else %}
                                    <i class="fas fa-hourglass-half text-warning mb-2 fs-4"></i>
                                    <div class="small text-muted">Devam Ediyor</div>
                                    <div class="fw-bold">-</div>
                                    <div class="small">-</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if test_result.completed_at %}
                        <div class="col-12">
                            <div class="text-center p-3 bg-primary text-white rounded">
                                <i class="fas fa-stopwatch mb-2 fs-4"></i>
                                <div class="small mb-1">Toplam Süre</div>
                                {% set duration = (test_result.completed_at - test_result.created_at).total_seconds() %}
                                <div class="h5 mb-0">
                                    {% if duration < 60 %}
                                        {{ "%.0f" | format(duration) }}s
                                    {% else %}
                                        {{ "%.1f" | format(duration / 60) }}dk
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Test Editor Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-user text-success me-2"></i> Test Eden</h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="bg-light rounded-circle mx-auto mb-2" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user text-muted fs-4"></i>
                        </div>
                        <h6 class="mb-1">{{ current_user.username }}</h6>
                        {% if current_user.is_admin %}
                            <span class="badge bg-warning"><i class="fas fa-crown me-1"></i>Admin</span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-user me-1"></i>Kullanıcı</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Test Results -->
        <div class="col-lg-8">
            <!-- Test Prompt Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-code text-primary me-2"></i> Test Prompt</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-dark mb-0">{{ test_result.prompt.name }}</h6>
                        <span class="badge bg-info">ID: {{ test_result.prompt_id }}</span>
                    </div>
                    <div class="bg-light rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        <pre class="mb-0 text-dark" style="white-space: pre-wrap; font-size: 0.9em;">{{ test_result.prompt.content }}</pre>
                    </div>
                </div>
            </div>

            <!-- Test Steps Results -->
            {% if test_result.status == 'completed' and formatted_steps %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i> Test Adımları ve Sonuçları</h5>
                        <small class="opacity-75">{{ formatted_steps|length }} adım tamamlandı</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="accordion" id="testStepsAccordion">
                            {% for step in formatted_steps %}
                            <div class="accordion-item border-0 border-bottom">
                                <h2 class="accordion-header">
                                    <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#step{{ loop.index }}" 
                                            aria-expanded="{% if loop.first %}true{% else %}false{% endif %}">
                                        <div class="d-flex align-items-center w-100">
                                            <span class="badge bg-primary rounded-pill me-3">{{ step.step_number }}</span>
                                            <div class="flex-grow-1">
                                                <strong>{{ step.action_type }}</strong>
                                                {% if step.details.get('success') == True %}
                                                    <i class="fas fa-check-circle text-success ms-2"></i>
                                                {% elif step.details.get('success') == False %}
                                                    <i class="fas fa-times-circle text-danger ms-2"></i>
                                                {% endif %}
                                            </div>
                                            {% if step.details.get('is_done') %}
                                                <span class="badge bg-success ms-2">Tamamlandı</span>
                                            {% endif %}
                                        </div>
                                    </button>
                                </h2>
                                <div id="step{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" 
                                     data-bs-parent="#testStepsAccordion">
                                    <div class="accordion-body">
                                        {% if step.details.get('extracted_content') %}
                                            <div class="mb-3">
                                                <h6 class="text-primary"><i class="fas fa-extract me-1"></i> Çıkarılan İçerik:</h6>
                                                <div class="bg-light rounded p-3">
                                                    <code class="text-dark">{{ step.details.extracted_content }}</code>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        {% if step.details.get('long_term_memory') %}
                                            <div class="mb-3">
                                                <h6 class="text-info"><i class="fas fa-brain me-1"></i> Agent Hafızası:</h6>
                                                <div class="bg-info bg-opacity-10 rounded p-3">
                                                    <em>{{ step.details.long_term_memory }}</em>
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        {% if step.details.get('content') %}
                                            <div class="mb-3">
                                                <h6 class="text-secondary"><i class="fas fa-file-alt me-1"></i> İçerik:</h6>
                                                <div class="bg-light rounded p-3">
                                                    {{ step.details.content }}
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        {% if step.raw_content and step.raw_content != step.details.get('content', '') %}
                                            <details class="mt-3">
                                                <summary class="text-muted small"><i class="fas fa-code me-1"></i> Ham Veri (Geliştiriciler için)</summary>
                                                <pre class="bg-light p-2 mt-2 small text-muted" style="max-height: 200px; overflow-y: auto;">{{ step.raw_content }}</pre>
                                            </details>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% elif test_result.status == 'completed' and test_result.result_text %}
                <!-- Fallback: Ham sonuç gösterimi -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i> Test Sonucu - Başarılı</h5>
                    </div>
                    <div class="card-body">
                        <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded p-3">
                            <pre class="mb-0 text-dark" style="white-space: pre-wrap; font-size: 0.9em;">{{ test_result.result_text }}</pre>
                        </div>
                    </div>
                </div>
            {% elif test_result.status == 'failed' and test_result.error_message %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Test Sonucu - Hata</h5>
                    </div>
                    <div class="card-body">
                        <div class="bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded p-3">
                            <pre class="mb-0 text-dark" style="white-space: pre-wrap; font-size: 0.9em;">{{ test_result.error_message }}</pre>
                        </div>
                    </div>
                </div>
            {% elif test_result.status == 'running' %}
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-spinner fa-spin me-2"></i> Test Durumu - Çalışıyor</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-4">
                            <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                            <p class="h6 text-muted">Test şu anda çalışıyor. Lütfen bekleyin...</p>
                            <div class="progress mt-3" style="height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                     role="progressbar" style="width: 100%" 
                                     aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-info" onclick="location.reload()">
                                <i class="fas fa-sync-alt me-2"></i> Durumu Yenile
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Test Information Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-info-circle text-info me-2"></i> Test Detayları</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-hashtag text-primary fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold text-dark">Test ID</div>
                                    <div class="text-muted">{{ test_result.id }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-folder text-warning fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold text-dark">Proje ID</div>
                                    <div class="text-muted">{{ test_result.project_id }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-globe text-success fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold text-dark">Test URL</div>
                                    <div class="text-muted">
                                        <a href="{{ test_result.project.url }}" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-external-link-alt me-1"></i>
                                            {{ test_result.project.url }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 flex-wrap">
                {% if test_result.status == 'running' %}
                    <button class="btn btn-info" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-2"></i> Sayfayı Yenile
                    </button>
                {% endif %}
                
                {% if test_result.status in ['completed', 'failed'] %}
                    <button class="btn btn-success" onclick="confirmRerun()">
                        <i class="fas fa-redo me-2"></i> Tekrar Çalıştır
                    </button>
                {% endif %}
                
                <a href="{{ url_for('test.test_history') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Test Geçmişine Dön
                </a>
                
                {% if test_result.status in ['completed', 'failed'] %}
                    <button class="btn btn-outline-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash me-2"></i> Testi Sil
                    </button>
                {% endif %}
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Tekrar Çalıştırma Onay Modal -->
<div class="modal fade" id="rerunModal" tabindex="-1" aria-labelledby="rerunModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title" id="rerunModalLabel">
                    <i class="fas fa-redo me-2"></i>Test Tekrar Çalıştır
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-question-circle text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="mb-3">Bu testi tekrar çalıştırmak istediğinizden emin misiniz?</h6>
                <p class="text-muted mb-0">
                    <small>
                        <strong>{{ test_result.prompt.name }}</strong> promptu ile yeni bir test başlatılacaktır.
                    </small>
                </p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>İptal
                </button>
                <button type="button" class="btn btn-success" onclick="executeRerun()">
                    <i class="fas fa-redo me-2"></i>Evet, Tekrar Çalıştır
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Çalışan test için otomatik yenileme
document.addEventListener('DOMContentLoaded', function() {
    const status = '{{ test_result.status }}';
    if (status === 'running') {
        // 15 saniyede bir sayfayı yenile
        setTimeout(function() {
            location.reload();
        }, 15000);
    }
});

// Test silme onayı ve işlemi
function confirmDelete() {
    if (confirm('Bu test sonucunu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
        const testId = {{ test_result.id }};
        
        fetch(`/tests/result/${testId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Başarılı silme sonrası test geçmişine yönlendir
                window.location.href = '/tests/history';
            } else {
                alert('Test silinirken bir hata oluştu: ' + (data.message || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Test silinirken bir hata oluştu. Lütfen tekrar deneyiniz.');
        });
    }
}

// Test tekrar çalıştırma onayı - Modal göster
function confirmRerun() {
    const rerunModal = new bootstrap.Modal(document.getElementById('rerunModal'));
    rerunModal.show();
}

// Test tekrar çalıştırma işlemini gerçekleştir
function executeRerun() {
    const testId = {{ test_result.id }};
    const rerunModal = bootstrap.Modal.getInstance(document.getElementById('rerunModal'));
    
    fetch(`/tests/result/${testId}/rerun`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        rerunModal.hide();
        if (data.success) {
            // Başarı mesajı göster ve yönlendir
            alert('Test başarıyla tekrar başlatıldı!');
            setTimeout(() => {
                window.location.href = `/tests/result/${data.new_test_id}`;
            }, 1000);
        } else {
            alert('Test tekrar çalıştırılırken bir hata oluştu: ' + (data.message || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        rerunModal.hide();
        console.error('Error:', error);
        alert('Test tekrar çalıştırılırken bir hata oluştu. Lütfen tekrar deneyiniz.');
    });
}

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Auto refresh indicator for running tests
if ('{{ test_result.status }}' === 'running') {
    let countdown = 15;
    const refreshButton = document.querySelector('button[onclick="location.reload()"]');
    
    if (refreshButton) {
        const originalText = refreshButton.innerHTML;
        const timer = setInterval(() => {
            countdown--;
            refreshButton.innerHTML = `<i class="fas fa-sync-alt me-2"></i> Otomatik yenileme: ${countdown}s`;
            
            if (countdown <= 0) {
                clearInterval(timer);
                refreshButton.innerHTML = originalText;
                location.reload();
            }
        }, 1000);
    }
}

// VNC açma fonksiyonu - Azure Container Apps uyumlu
function openVNC() {
    // Azure Container Apps'te sadece ana port (5005) açık olduğu için
    // noVNC'ye doğrudan erişim mümkün değil
    alert('ℹ️ VNC Bilgisi\n\nAzure Container Apps ortamında VNC görüntüsüne doğrudan erişim kısıtlıdır.\n\n' +
          '✅ Browser automation arka planda çalışmaya devam ediyor.\n' +
          '📊 Test sonuçlarını bu sayfada takip edebilirsiniz.\n' +
          '🔍 Container loglarında VNC aktivitesini görebilirsiniz.');
}
</script>
{% endblock %}